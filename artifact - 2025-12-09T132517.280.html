<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø´ÛŒÙ† ØªÙ†Ø§Ø³Ø¨ - Ø¨Ø§ ÙÙ„Ø´ Ø¬Ø§Ø¯ÙˆÛŒÛŒ Ø¯Ù‚ÛŒÙ‚</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;      
            --wrong: #c0392b;       
            --guide-color: #2980b9; 
            --target-color: #8e44ad;
            --bg-color: #f0f3f5;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 100px;
            user-select: none;
        }

        .header-panel {
            width: 100%; max-width: 800px; padding: 20px;
            display: flex; justify-content: center;
        }
        
        #scoreBoard {
            background: #f39c12; color: white;
            padding: 10px 30px; border-radius: 50px;
            font-size: 1.5rem; font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        #mainPanel {
            background: white;
            width: 90%; max-width: 800px;
            margin-top: 20px;
            padding: 40px 20px;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            text-align: center;
        }

        /* Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ Ú©Ø³Ø±Ù‡Ø§ */
        .fraction-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 150px; /* ÙØ§ØµÙ„Ù‡ Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ø¨Ù‡ØªØ± ÙÙ„Ø´ */
            font-size: 3rem;
            margin: 80px 0; 
            color: var(--primary);
            direction: ltr; 
            position: relative; 
            z-index: 1;
        }

        .frac-group {
            display: flex; flex-direction: column; align-items: center;
            gap: 15px; width: 100px; z-index: 2; position: relative;
        }

        .frac-line {
            width: 100%; height: 6px; background-color: var(--primary); border-radius: 10px;
        }

        .num-box {
            width: 110px; height: 80px; 
            display: flex; align-items: center; justify-content: center;
            background: #fff;
            border: 3px solid #ecf0f1;
            border-radius: 15px;
            font-weight: bold;
            position: relative;
            z-index: 2; 
            transition: all 0.3s;
        }
        
        .highlight-guide { 
            background-color: #ebf5fb; border-color: var(--guide-color); 
            color: var(--guide-color); 
            box-shadow: 0 0 20px rgba(41, 128, 185, 0.4);
            transform: scale(1.1);
            z-index: 10;
        }
        .highlight-target { 
            background-color: #f4ecf7; border-color: var(--target-color); 
            color: var(--target-color); 
            transform: scale(1.1);
            z-index: 10;
        }

        .input-main {
            width: 100%; height: 100%; font-size: 2.5rem; text-align: center;
            border: none; background: transparent; color: inherit; font-family: inherit; font-weight: bold;
        }
        .input-main:focus { outline: none; background: #fafafa; }
        .input-main:disabled { background: #f8f9f9; color: #95a5a6; }
        .input-main.correct { background: #eafaf1; color: var(--accent); }
        .input-main.wrong { background: #fdedec; color: var(--wrong); }

        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª SVG --- */
        .svg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 5; /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø®Ø· Ú©Ø³Ø± Ø§Ù…Ø§ Ù¾Ø§ÛŒÛŒÙ† ØªØ± Ø§Ø² Ø¨Ø§Ú©Ø³ Ø§Ø¹Ø¯Ø§Ø¯ */
            overflow: visible; 
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ÙÙ„Ø´â€ŒÙ‡Ø§ */
        path.arrow-path {
            fill: none; 
            stroke-width: 5; 
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.2)); /* Ø³Ø§ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø¬Ø³ØªÚ¯ÛŒ */
        }
        
        /* Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø±Ø³Ù… Ø®Ø· */
        .draw-anim {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 1.5s ease-out forwards;
        }
        
        @keyframes draw {
            to { stroke-dashoffset: 0; }
        }

        .arrow-dashed { stroke-dasharray: 15, 10; animation: none; /* Ø¯Ø´ Ø³Ø§Ø¯Ù‡ Ø¨Ø¯ÙˆÙ† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø±Ø³Ù… */ }
        
        /* --- Ø¨Ø§Ú©Ø³ Ø³Ø¨Ø² ÙˆØ±ÙˆØ¯ÛŒ Ø¶Ø±ÛŒØ¨ --- */
        .factor-box {
            position: absolute; 
            background: white;
            border: 3px solid var(--accent);
            border-radius: 15px;
            padding: 8px 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none; 
            flex-direction: row; align-items: center; gap: 8px;
            z-index: 100; 
            transform: translate(-50%, -50%); 
        }
        
        .factor-label { font-size: 0.9rem; color: #7f8c8d; font-weight: bold; }
        
        .factor-inputs-col { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        
        .f-input {
            width: 50px; height: 35px; 
            border: 2px solid #bdc3c7; 
            text-align: center; font-size: 1.2rem; 
            border-radius: 8px; color: var(--primary); font-weight: bold;
        }
        .f-input:focus { border-color: var(--accent); outline: none; }
        
        .f-line { width: 40px; height: 3px; background: var(--primary); border-radius: 2px; }
        
        .btn-mini-check {
            background: var(--accent); color: white; border: none;
            width: 32px; height: 32px; border-radius: 50%;
            font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .btn-mini-check:hover { transform: scale(1.1); }

        .check-main-btn {
            background: var(--guide-color); color: white; border: none; padding: 12px 40px;
            border-radius: 50px; font-size: 1.3rem; cursor: pointer; margin-top: 40px;
            box-shadow: 0 5px 15px rgba(41, 128, 185, 0.3);
            transition: transform 0.2s;
        }
        .check-main-btn:active { transform: scale(0.95); }

        .next-btn {
            background: #34495e; color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-size: 1.5rem; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-top: 40px; display: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .feedback { font-size: 1.3rem; margin-top: 20px; min-height: 35px; font-weight: bold; }

    </style>
</head>
<body>

    <div class="header-panel">
        <div id="scoreBoard">Ø§Ù…ØªÛŒØ§Ø²: 0</div>
    </div>

    <div id="mainPanel">
        <h2 style="color: #95a5a6; margin:0 0 20px 0; font-size: 1.1rem;">Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯ (Ù…Ø§Ø´ÛŒÙ† ØªÙ†Ø§Ø³Ø¨)</h2>
        
        <div class="fraction-display" id="quizContainer">
            <!-- Ù„Ø§ÛŒÙ‡ SVG Ø¨Ø±Ø§ÛŒ ÙÙ„Ø´â€ŒÙ‡Ø§ -->
            <svg class="svg-layer" id="arrowSvg">
                <defs>
                    <!-- ØªØ¹Ø±ÛŒÙ Ø³Ø± ÙÙ„Ø´â€ŒÙ‡Ø§ -->
                    <marker id="arrowhead-guide" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                        <path d="M0,0 L6,3 L0,6" fill="#2980b9" />
                    </marker>
                    <marker id="arrowhead-target" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                        <path d="M0,0 L6,3 L0,6" fill="#8e44ad" />
                    </marker>
                </defs>
            </svg>

            <!-- Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ÛŒ Ø¶Ø±ÛŒØ¨ -->
            <div id="factorBox1" class="factor-box">
                <span class="factor-label">Ø¶Ø±Ø¨</span>
                <div class="factor-inputs-col">
                    <input type="number" id="fb1_num" class="f-input" autocomplete="off">
                    <div class="f-line"></div>
                    <input type="number" id="fb1_den" class="f-input" autocomplete="off">
                </div>
                <button class="btn-mini-check" onclick="checkFactor(1)">âœ”</button>
            </div>

            <div id="factorBox2" class="factor-box">
                <span class="factor-label">Ø¶Ø±Ø¨</span>
                <div class="factor-inputs-col">
                    <input type="number" id="fb2_num" class="f-input" autocomplete="off">
                    <div class="f-line"></div>
                    <input type="number" id="fb2_den" class="f-input" autocomplete="off">
                </div>
                <button class="btn-mini-check" onclick="checkFactor(2)">âœ”</button>
            </div>

            <!-- Ú©Ø³Ø±Ù‡Ø§ ØªÙˆØ³Ø· Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <div class="feedback" id="feedback"></div>
        <button class="check-main-btn" id="mainCheckBtn" onclick="checkMainAnswer()">Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®</button>
        <button class="next-btn" id="nextBtn" onclick="generateProblem()">Ø³ÙˆØ§Ù„ Ø¨Ø¹Ø¯ÛŒ ğŸ²</button>
    </div>

    <script>
        let score = 0;
        let currentProblem = {};
        let problemHistory = [];
        let step = 0; // 0: Main, 1: Guide, 2: Target, 3: Retry
        let layoutInfo = {};
        let initialAttemptCorrect = false;

        function generateProblem() {
            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†ÛŒØ²
            document.getElementById('feedback').innerText = '';
            document.getElementById('mainCheckBtn').style.display = 'inline-block';
            document.getElementById('mainCheckBtn').innerText = 'Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('factorBox1').style.display = 'none';
            document.getElementById('factorBox2').style.display = 'none';
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù…Ø³ÛŒØ±Ù‡Ø§ÛŒ SVG Ù‚Ø¨Ù„ÛŒ (Ø¨Ù‡ Ø¬Ø² Defs)
            const svg = document.getElementById('arrowSvg');
            const paths = svg.querySelectorAll('path.arrow-path');
            paths.forEach(p => p.remove());

            // Ø±ÛŒØ³Øª ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
            ['fb1_num', 'fb1_den', 'fb2_num', 'fb2_den'].forEach(id => {
                const el = document.getElementById(id);
                el.value = ''; el.disabled = false; el.style.borderColor = '#bdc3c7';
            });
            document.querySelectorAll('.btn-mini-check').forEach(b => b.style.display = 'flex');

            step = 0;
            initialAttemptCorrect = false;

            // ØªÙˆÙ„ÛŒØ¯ Ø§Ø¹Ø¯Ø§Ø¯ ØªØµØ§Ø¯ÙÛŒ (ØªØ¶Ù…ÛŒÙ† ÛŒÚ©ØªØ§ÛŒÛŒ)
            let uniqueFound = false;
            let nums = [];

            while (!uniqueFound) {
                const denoms = [2, 3, 4, 5];
                const q = denoms[Math.floor(Math.random() * denoms.length)]; 
                let p;
                do { p = Math.floor(Math.random() * 5) + 2; } while (p === q || (p % q === 0));

                let seed1 = Math.floor(Math.random() * 5) + 2;
                let seed2 = seed1 + (Math.floor(Math.random() * 3) + 1);

                // N1/D1 = N2/D2
                let N1 = seed1 * q; 
                let D1 = seed2 * q;
                let N2 = seed1 * p;
                let D2 = seed2 * p;

                // ØªØµØ§Ø¯ÙÛŒ Ú©Ø±Ø¯Ù† Ø¬Ø§ÛŒ Ú©Ø³Ø±Ù‡Ø§
                if(Math.random() > 0.5) { [N1, N2] = [N2, N1]; [D1, D2] = [D2, D1]; }

                nums = [N1, D1, N2, D2];
                const hash = nums.join('-');
                
                if (!problemHistory.includes(hash)) {
                    problemHistory.push(hash);
                    if (problemHistory.length > 20) problemHistory.shift();
                    uniqueFound = true;
                }
            }

            const uIdx = Math.floor(Math.random() * 4); // Ø§Ù†Ø¯ÛŒØ³ Ù…Ø¬Ù‡ÙˆÙ„
            currentProblem = { vals: nums, uIdx: uIdx, ans: nums[uIdx] };
            
            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø³Ø±Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ
            const oldGroups = container.querySelectorAll('.frac-group, .equals-sign');
            oldGroups.forEach(el => el.remove());

            const vals = currentProblem.vals;
            const uIdx = currentProblem.uIdx;

            // Ø³Ø§Ø®Øª Ú©Ø³Ø± Ø§ÙˆÙ„ (Ø§Ù†Ø¯ÛŒØ³ 0 Ùˆ 1)
            const group1 = createFracGroup(vals[0], vals[1], uIdx, 0, 1);
            
            const eq = document.createElement('div'); 
            eq.className = 'equals-sign';
            eq.innerHTML = '='; 
            eq.style.fontSize='3rem'; eq.style.margin = '0 10px';

            // Ø³Ø§Ø®Øª Ú©Ø³Ø± Ø¯ÙˆÙ… (Ø§Ù†Ø¯ÛŒØ³ 2 Ùˆ 3)
            const group2 = createFracGroup(vals[2], vals[3], uIdx, 2, 3);

            container.appendChild(group1);
            container.appendChild(eq);
            container.appendChild(group2);
        }

        function createFracGroup(nVal, dVal, uIdx, nId, dId) {
            const div = document.createElement('div');
            div.className = 'frac-group';
            
            const nBox = document.createElement('div'); nBox.className = 'num-box'; nBox.id = `box_${nId}`;
            if (uIdx === nId) nBox.innerHTML = `<input id="mainInput" class="input-main" type="number" placeholder="ØŸ" autocomplete="off">`;
            else nBox.innerText = nVal;

            const line = document.createElement('div'); line.className = 'frac-line';

            const dBox = document.createElement('div'); dBox.className = 'num-box'; dBox.id = `box_${dId}`;
            if (uIdx === dId) dBox.innerHTML = `<input id="mainInput" class="input-main" type="number" placeholder="ØŸ" autocomplete="off">`;
            else dBox.innerText = dVal;

            div.appendChild(nBox);
            div.appendChild(line);
            div.appendChild(dBox);
            return div;
        }

        function checkMainAnswer() {
            if (step === 3) {
                finalizeAnswer();
                return;
            }
            if (step > 0) return; 

            const input = document.getElementById('mainInput');
            const val = parseInt(input.value);
            const feedback = document.getElementById('feedback');

            if (isNaN(val)) {
                feedback.innerText = "Ù„Ø·ÙØ§ Ø¹Ø¯Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
                return;
            }

            if (val === currentProblem.ans) {
                input.classList.add('correct');
                input.disabled = true;
                initialAttemptCorrect = true;
                score += 2; 
                document.getElementById('scoreBoard').innerText = `Ø§Ù…ØªÛŒØ§Ø²: ${score}`;
                feedback.innerHTML = "Ø¢ÙØ±ÛŒÙ†! Ø­Ø§Ù„Ø§ Ù…Ø³ÛŒØ± Ø¶Ø±Ø¨ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†.";
                feedback.style.color = "var(--accent)";
            } else {
                input.classList.add('wrong');
                feedback.innerText = "Ø§Ø´ØªØ¨Ø§Ù‡ Ù†ÙˆØ´ØªÛŒ. Ø­Ø§Ù„Ø§ Ø¨Ø¨ÛŒÙ†ÛŒÙ… Ø¶Ø±Ø¨Ø´ Ú†Ø·ÙˆØ± Ù…ÛŒØ´Ù‡.";
                feedback.style.color = "var(--wrong)";
                score = Math.max(0, score - 1);
                document.getElementById('scoreBoard').innerText = `Ø§Ù…ØªÛŒØ§Ø²: ${score}`;
                
                setTimeout(() => {
                    input.value = '';
                    input.classList.remove('wrong');
                    input.disabled = true; 
                }, 1000);
            }

            document.getElementById('mainCheckBtn').style.display = 'none';
            step = 1;
            // Ú©Ù…ÛŒ ØªØ§Ø®ÛŒØ± Ø¨Ø±Ø§ÛŒ Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ DOM Ø§Ú¯Ø± ØªØºÛŒÛŒØ±ÛŒ Ø¨ÙˆØ¯Ù‡ Ø¨Ø§Ø´Ø¯
            setTimeout(initTeachingFlow, 500);
        }

        function initTeachingFlow() {
            const p = currentProblem;
            // ØªØ¹ÛŒÛŒÙ† Ø¬Ù‡Øª ÙÙ„Ø´ (Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª ÛŒØ§ Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾)
            // Ù‚Ø§Ù†ÙˆÙ†: ÙÙ„Ø´ Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² Ø·Ø±Ù "Ù…Ø¹Ù„ÙˆÙ…" Ø¨Ù‡ Ø³Ù…Øª "Ù…Ø¬Ù‡ÙˆÙ„" Ù…ÛŒâ€ŒØ±ÙˆØ¯ ØªØ§ Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² Ø¨ÙÙ‡Ù…Ø¯ Ú†Ù‡ Ø¨Ù„Ø§ÛŒÛŒ Ø³Ø± Ø¹Ø¯Ø¯ Ø¢Ù…Ø¯Ù‡
            // Ø§Ú¯Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø³Ù…Øª Ø±Ø§Ø³Øª Ø§Ø³Øª (Ø§Ù†Ø¯ÛŒØ³ 2 ÛŒØ§ 3)ØŒ ÙÙ„Ø´â€ŒÙ‡Ø§ Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª (0->2 Ùˆ 1->3) Ù‡Ø³ØªÙ†Ø¯.
            // Ø§Ú¯Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø³Ù…Øª Ú†Ù¾ Ø§Ø³Øª (Ø§Ù†Ø¯ÛŒØ³ 0 ÛŒØ§ 1)ØŒ ÙÙ„Ø´â€ŒÙ‡Ø§ Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾ (2->0 Ùˆ 3->1) Ù‡Ø³ØªÙ†Ø¯.
            
            const isUnknownRight = (p.uIdx === 2 || p.uIdx === 3);
            
            // Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§: Ø³Ø·Ø±ÛŒ Ú©Ù‡ Ù‡Ø± Ø¯Ùˆ Ø¹Ø¯Ø¯Ø´ Ù…Ø¹Ù„ÙˆÙ… Ø§Ø³Øª
            // Ø§Ú¯Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø§Ù†Ø¯ÛŒØ³ 0 (ØµÙˆØ±Øª Ú†Ù¾) Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§ Ù¾Ø§ÛŒÛŒÙ† Ø§Ø³Øª.
            // Ø§Ú¯Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø§Ù†Ø¯ÛŒØ³ 1 (Ù…Ø®Ø±Ø¬ Ú†Ù¾) Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø§Ù„Ø§ Ø§Ø³Øª.
            // Ø§Ú¯Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø§Ù†Ø¯ÛŒØ³ 2 (ØµÙˆØ±Øª Ø±Ø§Ø³Øª) Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§ Ù¾Ø§ÛŒÛŒÙ† Ø§Ø³Øª.
            // Ø§Ú¯Ø± Ù…Ø¬Ù‡ÙˆÙ„ Ø§Ù†Ø¯ÛŒØ³ 3 (Ù…Ø®Ø±Ø¬ Ø±Ø§Ø³Øª) Ø¨Ø§Ø´Ø¯ØŒ Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø§Ù„Ø§ Ø§Ø³Øª.
            const isTopRowUnknown = (p.uIdx === 0 || p.uIdx === 2);
            const guideRow = isTopRowUnknown ? 'bottom' : 'top'; // Ø§Ú¯Ø± Ø¨Ø§Ù„Ø§ Ù…Ø¬Ù‡ÙˆÙ„ Ø¯Ø§Ø±Ø¯ØŒ Ù¾Ø§ÛŒÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§Ø³Øª

            // ØªØ¹ÛŒÛŒÙ† Ø§Ù†Ø¯ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ùˆ Ù¾Ø§ÛŒØ§Ù†
            // Top Row Indices: 0 and 2
            // Bottom Row Indices: 1 and 3
            
            let startIdxTop, endIdxTop, startIdxBot, endIdxBot;

            if (isUnknownRight) {
                // ÙÙ„Ø´ Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª
                startIdxTop = 0; endIdxTop = 2;
                startIdxBot = 1; endIdxBot = 3;
            } else {
                // ÙÙ„Ø´ Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾
                startIdxTop = 2; endIdxTop = 0;
                startIdxBot = 3; endIdxBot = 1;
            }

            layoutInfo = {
                guideRow: guideRow,
                startIdxTop: startIdxTop,
                endIdxTop: endIdxTop,
                startIdxBot: startIdxBot,
                endIdxBot: endIdxBot
            };

            showGuideArrow();
        }

        function showGuideArrow() {
            const info = layoutInfo;
            // Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¯ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§
            const start = info.guideRow === 'top' ? info.startIdxTop : info.startIdxBot;
            const end = info.guideRow === 'top' ? info.endIdxTop : info.endIdxBot;
            
            // Ø±Ø³Ù… ÙÙ„Ø´
            drawArrow(start, end, 'var(--guide-color)', 'url(#arrowhead-guide)', 'guidePath', info.guideRow);
            
            // Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ú©Ø±Ø¯Ù† Ø¨Ø§Ú©Ø³â€ŒÙ‡Ø§
            document.getElementById(`box_${start}`).classList.add('highlight-guide');
            document.getElementById(`box_${end}`).classList.add('highlight-guide');

            // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§Ú©Ø³ ÙˆØ±ÙˆØ¯ÛŒ Ø±ÙˆÛŒ ÙÙ„Ø´
            showFactorBox('factorBox1', start, end, info.guideRow);
        }

        function showTargetArrow() {
            const info = layoutInfo;
            // Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù†Ø¯ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø³Ø·Ø± Ù‡Ø¯Ù (Ú©Ù‡ Ù…Ø¬Ù‡ÙˆÙ„ Ø¯Ø§Ø±Ø¯)
            const start = info.guideRow === 'top' ? info.startIdxBot : info.startIdxTop;
            const end = info.guideRow === 'top' ? info.endIdxBot : info.endIdxTop;

            drawArrow(start, end, 'var(--target-color)', 'url(#arrowhead-target)', 'targetPath', info.guideRow === 'top' ? 'bottom' : 'top');

            document.getElementById(`box_${start}`).classList.add('highlight-target');
            document.getElementById(`box_${end}`).classList.add('highlight-target');

            showFactorBox('factorBox2', start, end, info.guideRow === 'top' ? 'bottom' : 'top');
        }

        function drawArrow(fromId, toId, color, marker, pathId, rowType) {
            const svg = document.getElementById('arrowSvg');
            const container = document.getElementById('quizContainer');
            
            const fromEl = document.getElementById(`box_${fromId}`);
            const toEl = document.getElementById(`box_${toId}`);
            
            // ** Ø§ØµÙ„Ø§Ø­ Ø­ÛŒØ§ØªÛŒ: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø®ØªØµØ§Øª Ù†Ø³Ø¨Øª Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§ØµÙ„ÛŒ **
            const cRect = container.getBoundingClientRect();
            const fRect = fromEl.getBoundingClientRect();
            const tRect = toEl.getBoundingClientRect();

            const p1 = {
                x: fRect.left - cRect.left + fRect.width / 2,
                y: fRect.top - cRect.top + fRect.height / 2
            };
            const p2 = {
                x: tRect.left - cRect.left + tRect.width / 2,
                y: tRect.top - cRect.top + tRect.height / 2
            };

            // ØªØ¹ÛŒÛŒÙ† Ø¬Ù‡Øª Ø§Ù†Ø­Ù†Ø§: Ø³Ø·Ø± Ø¨Ø§Ù„Ø§ Ø¨Ù‡ Ø³Ù…Øª Ø¨Ø§Ù„Ø§ Ø®Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø³Ø·Ø± Ù¾Ø§ÛŒÛŒÙ† Ø¨Ù‡ Ø³Ù…Øª Ù¾Ø§ÛŒÛŒÙ†
            const isTop = (rowType === 'top');
            const curvature = isTop ? -90 : 90; // Ù…Ù‚Ø¯Ø§Ø± Ø®Ù…ÛŒØ¯Ú¯ÛŒ
            
            const midX = (p1.x + p2.x) / 2;
            const midY = (p1.y + p2.y) / 2 + curvature;

            const d = `M ${p1.x} ${p1.y} Q ${midX} ${midY} ${p2.x} ${p2.y}`;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", d);
            path.setAttribute("class", "arrow-path draw-anim"); // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
            path.setAttribute("id", pathId);
            path.style.stroke = color;
            path.setAttribute("marker-end", marker);

            svg.appendChild(path);
        }

        function showFactorBox(boxId, fromId, toId, rowType) {
            const box = document.getElementById(boxId);
            const container = document.getElementById('quizContainer');
            
            const fromEl = document.getElementById(`box_${fromId}`);
            const toEl = document.getElementById(`box_${toId}`);
            
            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ú©Ø³
            const cRect = container.getBoundingClientRect();
            const fRect = fromEl.getBoundingClientRect();
            const tRect = toEl.getBoundingClientRect();

            const x1 = fRect.left - cRect.left + fRect.width / 2;
            const y1 = fRect.top - cRect.top + fRect.height / 2;
            const x2 = tRect.left - cRect.left + tRect.width / 2;
            const y2 = tRect.top - cRect.top + tRect.height / 2;

            const isTop = (rowType === 'top');
            const curvature = isTop ? -90 : 90;
            
            // Ù†Ù‚Ø·Ù‡ Ø§ÙˆØ¬ Ù…Ù†Ø­Ù†ÛŒ (Ù‚Ù„Ù‡)
            const controlX = (x1 + x2) / 2;
            const controlY = (y1 + y2) / 2 + curvature;

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù‚Ø·Ù‡ Ø±ÙˆÛŒ Ù…Ù†Ø­Ù†ÛŒ (t=0.5) - ÙØ±Ù…ÙˆÙ„ Bezier Ø¯Ø±Ø¬Ù‡ 2
            // B(t) = (1-t)^2 P0 + 2(1-t)t P1 + t^2 P2
            // Ø¨Ø±Ø§ÛŒ t=0.5: 0.25*P0 + 0.5*P1 + 0.25*P2
            const midX = 0.25*x1 + 0.5*controlX + 0.25*x2;
            const midY = 0.25*y1 + 0.5*controlY + 0.25*y2;

            box.style.left = `${midX}px`;
            box.style.top = `${midY}px`;
            box.style.display = 'flex';
            
            // ÙÙˆÚ©ÙˆØ³ Ø±ÙˆÛŒ ÙˆØ±ÙˆØ¯ÛŒ
            setTimeout(() => { box.querySelector('input').focus(); }, 200);
        }

        function checkFactor(boxNum) {
            const p = currentProblem;
            const info = layoutInfo;
            
            let fromVal, toVal;
            
            // ØªØ¹ÛŒÛŒÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ø¶Ø±Ø¨
            // Ù…Ù‡Ù…: Ù‡Ù…ÛŒØ´Ù‡ Ø§Ø² Ù…Ù‚Ø§Ø¯ÛŒØ± ÙˆØ§Ù‚Ø¹ÛŒ Ø±ÛŒØ§Ø¶ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ Ù†Ù‡ Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø¯Ø± Ø¨Ø§Ú©Ø³ Ù†ÙˆØ´ØªÙ‡ Ø´Ø¯Ù‡
            // (Ú†ÙˆÙ† Ø¨Ø§Ú©Ø³ Ù…Ù‚ØµØ¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø®Ø§Ù„ÛŒ ÛŒØ§ Ø§Ø´ØªØ¨Ø§Ù‡ Ø¨Ø§Ø´Ø¯)
            
            if (boxNum === 1) { 
                // Ø³Ø·Ø± Ø±Ø§Ù‡Ù†Ù…Ø§
                const startIdx = info.guideRow === 'top' ? info.startIdxTop : info.startIdxBot;
                const endIdx = info.guideRow === 'top' ? info.endIdxTop : info.endIdxBot;
                fromVal = p.vals[startIdx];
                toVal = p.vals[endIdx];
            } else { 
                // Ø³Ø·Ø± Ù‡Ø¯Ù
                const startIdx = info.guideRow === 'top' ? info.startIdxBot : info.startIdxTop;
                const endIdx = info.guideRow === 'top' ? info.endIdxBot : info.endIdxTop;
                fromVal = p.vals[startIdx];
                toVal = p.vals[endIdx];
            }

            const nInput = document.getElementById(`fb${boxNum}_num`);
            const dInput = document.getElementById(`fb${boxNum}_den`);
            const uN = parseInt(nInput.value);
            const uD = parseInt(dInput.value);

            if (isNaN(uN) || isNaN(uD)) return; 

            // Ø¨Ø±Ø±Ø³ÛŒ ØªÙ†Ø§Ø³Ø¨: Ø¢ÛŒØ§ fromVal * (uN/uD) == toVal ØŸ
            // Ù…Ø¹Ø§Ø¯Ù„: fromVal * uN == toVal * uD
            if (Math.abs((fromVal * uN) - (toVal * uD)) < 0.001) { // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ„ÙˆØ±Ø§Ù†Ø³ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†
                // Ø¯Ø±Ø³Øª Ø§Ø³Øª
                nInput.disabled = true; dInput.disabled = true;
                nInput.style.borderColor = "var(--accent)"; dInput.style.borderColor = "var(--accent)";
                document.querySelector(`#factorBox${boxNum} .btn-mini-check`).style.display = 'none';
                
                // ØªØºÛŒÛŒØ± Ø§Ø³ØªØ§ÛŒÙ„ ÙÙ„Ø´
                const pathId = boxNum === 1 ? 'guidePath' : 'targetPath';
                const pathEl = document.getElementById(pathId);
                pathEl.classList.remove('draw-anim'); // Ø­Ø°Ù Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø±Ø³Ù…
                pathEl.style.strokeDasharray = 'none'; // Ø®Ø· Ù…Ù…ØªØ¯

                if (boxNum === 1) {
                    step = 2;
                    setTimeout(showTargetArrow, 500);
                } else {
                    // Ù¾Ø§ÛŒØ§Ù† Ù…Ø±Ø§Ø­Ù„ Ø¶Ø±Ø¨
                    if (initialAttemptCorrect) {
                         document.getElementById('feedback').innerText = "Ø¹Ø§Ù„ÛŒ! Ø³ÙˆØ§Ù„ ØªÙ…Ø§Ù… Ø´Ø¯.";
                         document.getElementById('nextBtn').style.display = 'inline-block';
                    } else {
                        step = 3;
                        const mainInput = document.getElementById('mainInput');
                        mainInput.disabled = false;
                        mainInput.value = '';
                        mainInput.focus();
                        document.getElementById('feedback').innerText = "Ø­Ø§Ù„Ø§ Ú©Ù‡ Ø§Ù„Ú¯ÙˆÛŒ Ø¶Ø±Ø¨ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯ÛŒØŒ Ù¾Ø§Ø³Ø® ØµØ­ÛŒØ­ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³.";
                        document.getElementById('feedback').style.color = "#34495e";
                        const chkBtn = document.getElementById('mainCheckBtn');
                        chkBtn.style.display = 'inline-block';
                        chkBtn.innerText = "Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ";
                    }
                }
            } else {
                nInput.style.borderColor = "var(--wrong)";
                dInput.style.borderColor = "var(--wrong)";
            }
        }

        function finalizeAnswer() {
            const input = document.getElementById('mainInput');
            const val = parseInt(input.value);
            const feedback = document.getElementById('feedback');

            if (val === currentProblem.ans) {
                input.classList.add('correct');
                input.disabled = true;
                feedback.innerText = "Ø¢ÙØ±ÛŒÙ†! ØµØ­ÛŒØ­ Ø§Ø³Øª.";
                feedback.style.color = "var(--accent)";
                document.getElementById('mainCheckBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                input.classList.add('wrong');
                feedback.innerText = "Ø¯Ù‚Øª Ú©Ù†! Ø¶Ø±Ø¨ Ø±Ø§ Ø±ÙˆÛŒ Ø¹Ø¯Ø¯ Ù…Ø¨Ø¯Ø§ Ø§Ø¹Ù…Ø§Ù„ Ú©Ù†.";
                setTimeout(() => input.classList.remove('wrong'), 1000);
            }
        }

        window.onload = generateProblem;
        // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ø®ØªØµØ§Øª Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ ØµÙØ­Ù‡
        window.onresize = () => {
             // Ø§Ú¯Ø± Ø¯Ø± Ù…ÛŒØ§Ù†Ù‡ Ø­Ù„ Ø³ÙˆØ§Ù„ Ø¨Ø§Ø´ÛŒÙ…ØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª ÙÙ„Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ Ù‡Ù… Ø¨Ø±ÛŒØ²Ø¯
             // Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¯Ú¯ÛŒØŒ ÙØ¹Ù„Ø§ Ú©Ø§Ø±ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ÛŒØ§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒÙ… Ø±ÛŒÙ„ÙˆØ¯ Ú©Ù†ÛŒÙ…
             // Ø§Ù…Ø§ Ú†ÙˆÙ† Ø§Ø² getBoundingClientRect Ø¯Ø± Ù„Ø­Ø¸Ù‡ ØªØ±Ø³ÛŒÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…ØŒ
             // ÙÙ‚Ø· Ø¨Ø§ Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¯Ø±Ø³Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        };

    </script>
</body>
</html>
