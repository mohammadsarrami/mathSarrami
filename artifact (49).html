<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آزمایشگاه تخصصی ضرب کسرها</title>
    <style>
        @import url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font/dist/font-face.css');

        body {
            font-family: 'Vazir', sans-serif;
            background-color: #f4f6f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { color: #2c3e50; margin-bottom: 10px; text-align: center; }

        /* Tabs */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: #fff;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab-btn {
            border: none;
            background: none;
            padding: 10px 20px;
            font-family: 'Vazir', sans-serif;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 40px;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background-color: #2c3e50;
            color: white;
            box-shadow: 0 2px 5px rgba(44, 62, 80, 0.4);
        }

        /* Content Areas */
        .lab-container {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 900px;
            animation: fadeIn 0.5s;
        }

        .lab-container.active { display: flex; flex-direction: column; gap: 20px; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .description {
            background: #e8f6f3;
            border-right: 5px solid #1abc9c;
            padding: 15px;
            border-radius: 5px;
            color: #16a085;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e9ecef;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        input[type="range"] { width: 140px; cursor: pointer; }

        /* Math Display - LTR Forced */
        .math-display {
            direction: ltr;
            unicode-bidi: embed;
            font-size: 2.2rem;
            font-weight: bold;
            text-align: center;
            margin: 15px 0;
            color: #2c3e50;
            font-family: 'Times New Roman', serif;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 12px;
        }

        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            font-size: 0.8em;
            margin: 0 5px;
        }
        .fraction > span { display: block; padding: 0 2px; }
        .fraction span.bottom { border-top: 2px solid #000; }

        /* Visualizations */
        .visualization-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 40px;
            margin-top: 20px;
        }

        .canvas-container {
            width: 100%;
            overflow-x: auto;
            display: flex;
            justify-content: center;
            padding: 10px 0;
            background: #fff;
        }

        .shapes-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        
        svg.axis-svg { overflow: visible; min-width: 600px; }

        /* Grid Model */
        .grid-model-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            overflow: auto;
            max-width: 100%;
        }
        
        .grid-container {
            display: grid;
            border: 3px solid #2c3e50;
            background-color: #fff;
        }

        .grid-cell {
            border: 1px solid #bdc3c7;
            box-sizing: border-box;
            position: relative;
        }

        .fill-green { background-color: rgba(46, 204, 113, 0.6); } 
        .fill-yellow { background-color: rgba(241, 196, 15, 0.6); } 
        .fill-overlap { background-color: rgba(39, 174, 96, 1) !important; }
        
    </style>
</head>
<body>

    <h1>آزمایشگاه ریاضی (مفهوم ضرب کسر)</h1>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('tab1')">۱. ضرب عدد در کسر</button>
        <button class="tab-btn" onclick="switchTab('tab2')">۲. ضرب کسر در عدد</button>
        <button class="tab-btn" onclick="switchTab('tab3')">۳. ضرب کسر در کسر</button>
    </div>

    <!-- TAB 1: Integer x Fraction -->
    <div id="tab1" class="lab-container active">
        <div class="description">
            <b>ضرب عدد در کسر (تکرار و تجمیع):</b><br>
            شکل‌ها: هر دسته (عدد صحیح) با رنگ جداگانه نمایش داده می‌شود. قطعات پشت سر هم چیده می‌شوند.<br>
            محور: هر پرش نشان‌دهنده یک دسته است و رنگ آن با رنگ شکل‌ها یکی است.
        </div>
        <div class="controls">
            <div class="control-group">
                <label>عدد صحیح (تعداد بسته‌ها): <span id="t1-int-val">3</span></label>
                <input type="range" id="t1-int" min="1" max="10" value="3" oninput="updateTab1()">
            </div>
            <div class="control-group">
                <label>صورت کسر (سهم هر بسته): <span id="t1-num-val">2</span></label>
                <input type="range" id="t1-num" min="1" max="20" value="2" oninput="updateTab1()">
            </div>
            <div class="control-group">
                <label>مخرج کسر: <span id="t1-den-val">5</span></label>
                <input type="range" id="t1-den" min="2" max="20" value="5" oninput="updateTab1()">
            </div>
        </div>

        <div class="math-display" id="t1-equation"></div>

        <div class="visualization-area">
            <h3>نمایش با دایره (تجمیع رنگی)</h3>
            <div class="shapes-wrapper" id="t1-shapes"></div>
            
            <h3>نمایش روی محور (پرش‌های رنگی)</h3>
            <div class="canvas-container" id="t1-axis-container"></div>
        </div>
    </div>

    <!-- TAB 2: Fraction x Integer -->
    <div id="tab2" class="lab-container">
         <div class="description">
            <b>ضرب کسر در عدد (برش از واحدها):</b><br>
            شکل‌ها: به تعداد عدد، واحد می‌کشیم. از هر واحد به اندازه کسر برمی‌داریم.<br>
            محور: روی هر واحد (فاصله ۰ تا ۱، ۱ تا ۲ و...) یک پرش کوچک به اندازه کسر می‌زنیم.
        </div>
        <div class="controls">
            <div class="control-group">
                <label>صورت کسر (سهم از هر واحد): <span id="t2-num-val">3</span></label>
                <input type="range" id="t2-num" min="1" max="20" value="3" oninput="updateTab2()">
            </div>
            <div class="control-group">
                <label>مخرج کسر (برش هر واحد): <span id="t2-den-val">5</span></label>
                <input type="range" id="t2-den" min="2" max="20" value="5" oninput="updateTab2()">
            </div>
             <div class="control-group">
                <label>عدد صحیح (تعداد واحدها): <span id="t2-int-val">2</span></label>
                <input type="range" id="t2-int" min="1" max="10" value="2" oninput="updateTab2()">
            </div>
        </div>

        <div class="math-display" id="t2-equation"></div>

        <div class="visualization-area">
             <h3>نمایش با دایره (برش از هر شکل)</h3>
             <div class="shapes-wrapper" id="t2-shapes"></div>

            <h3>نمایش روی محور (عمل روی هر واحد)</h3>
            <div class="canvas-container" id="t2-axis-container"></div>
        </div>
    </div>

    <!-- TAB 3: Fraction x Fraction -->
    <div id="tab3" class="lab-container">
        <div class="description">
            <b>ضرب کسر در کسر (مساحت):</b><br>
            نمایش تداخل دو کسر روی یک واحد (زمین).
        </div>
        <div class="controls">
            <div class="control-group" style="border-left: 2px solid #ddd; padding-left: 10px;">
                <label style="color: #27ae60; font-weight:bold;">کسر اول (افقی)</label>
                <br>
                <label>صورت: <span id="t3-n1-val">3</span></label>
                <input type="range" id="t3-n1" min="1" max="20" value="3" oninput="updateTab3()">
                <label>مخرج: <span id="t3-d1-val">4</span></label>
                <input type="range" id="t3-d1" min="2" max="20" value="4" oninput="updateTab3()">
            </div>
            
            <div class="control-group">
                <label style="color: #f39c12; font-weight:bold;">کسر دوم (عمودی)</label>
                <br>
                <label>صورت: <span id="t3-n2-val">2</span></label>
                <input type="range" id="t3-n2" min="1" max="20" value="2" oninput="updateTab3()">
                <label>مخرج: <span id="t3-d2-val">5</span></label>
                <input type="range" id="t3-d2" min="2" max="20" value="5" oninput="updateTab3()">
            </div>
        </div>

        <div class="math-display" id="t3-equation"></div>

        <div class="visualization-area">
            <h3>مدل مساحتی (شبکه‌ای)</h3>
            <div class="grid-model-wrapper" id="t3-grid-wrapper"></div>
        </div>
    </div>

    <script>
        // پالت رنگ برای بسته‌های مختلف
        const distinctColors = [
            '#e74c3c', // قرمز
            '#3498db', // آبی
            '#2ecc71', // سبز
            '#9b59b6', // بنفش
            '#f1c40f', // زرد
            '#e67e22', // نارنجی پررنگ
            '#1abc9c', // فیروزه‌ای
            '#34495e', // سرمه‌ای
            '#d35400', // آجری
            '#7f8c8d'  // طوسی
        ];

        function makeFrac(n, d) {
            return `<div class="fraction"><span>${n}</span><span class="bottom">${d}</span></div>`;
        }

        function createSVGElement(tag, attrs) {
            const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
            for (let key in attrs) {
                el.setAttribute(key, attrs[key]);
            }
            return el;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.lab-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`button[onclick="switchTab('${tabId}')"]`).classList.add('active');

            if(tabId === 'tab1') updateTab1();
            if(tabId === 'tab2') updateTab2();
            if(tabId === 'tab3') updateTab3();
        }

        // --- توابع رسم دایره جدید (چند رنگی) ---
        
        // تابع کمکی برای ساخت مسیر یک قاچ
        function createSlicePath(cx, cy, r, startAngle, endAngle) {
            const x1 = cx + r * Math.cos(startAngle);
            const y1 = cy + r * Math.sin(startAngle);
            const x2 = cx + r * Math.cos(endAngle);
            const y2 = cy + r * Math.sin(endAngle);
            
            // محاسبه پرچم کمان بزرگ (برای زوایای بیش از ۱۸۰ درجه که اینجا معمولا پیش نمی‌آید چون قاچ‌ها کوچک‌اند)
            // اما فرمول کلی:
            let dAngle = endAngle - startAngle;
            // نرمال‌سازی زاویه
            while (dAngle < 0) dAngle += 2*Math.PI;
            const largeArc = dAngle > Math.PI ? 1 : 0;

            return `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArc} 1 ${x2} ${y2} Z`;
        }

        function createMultiColorPieSVG(radius, den, startGlobalIndex, num, integerCount) {
            const size = 110;
            const center = size / 2;
            const svg = createSVGElement("svg", {width: size, height: size});
            const totalFilledSlices = integerCount * num;

            // رسم قاچ‌های رنگی
            for (let s = 0; s < den; s++) {
                const currentGlobalIndex = startGlobalIndex + s;
                
                // فقط اگر این قاچ باید پر باشد
                if (currentGlobalIndex < totalFilledSlices) {
                    // محاسبه اینکه این قاچ متعلق به کدام بسته (عدد صحیح) است
                    const groupIndex = Math.floor(currentGlobalIndex / num);
                    const color = distinctColors[groupIndex % distinctColors.length];

                    const angleStep = (2 * Math.PI) / den;
                    const startAngle = (s * angleStep) - (Math.PI / 2);
                    const endAngle = startAngle + angleStep;

                    const d = createSlicePath(center, center, radius, startAngle, endAngle);
                    
                    svg.appendChild(createSVGElement("path", {
                        d: d, fill: color, stroke: "none", opacity: 0.8
                    }));
                }
            }

            // دایره محیط و خطوط تقسیم (روی رنگ‌ها)
            svg.appendChild(createSVGElement("circle", {
                cx: center, cy: center, r: radius, fill: "none", stroke: "#000", "stroke-width": 2.5
            }));

            for (let k = 0; k < den; k++) {
                const angle = (k * 2 * Math.PI) / den - (Math.PI/2);
                const x2 = center + radius * Math.cos(angle);
                const y2 = center + radius * Math.sin(angle);
                svg.appendChild(createSVGElement("line", {
                    x1: center, y1: center, x2: x2, y2: y2, stroke: "#000", "stroke-width": 1.5
                }));
            }

            return svg;
        }

        // --- استراتژی ۱: پر کردن پیوسته با رنگ‌های متفاوت ---
        function drawShapesCumulative(containerId, integer, num, den) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            let totalParts = integer * num;
            let circlesNeeded = Math.ceil(totalParts / den);
            
            for (let i = 0; i < circlesNeeded; i++) {
                // هر دایره از اندیس جهانی خاصی شروع می‌شود
                // دایره ۰: اندیس ۰ تا den-1
                // دایره ۱: اندیس den تا 2*den-1 ...
                const startGlobalIndex = i * den;
                const svg = createMultiColorPieSVG(48, den, startGlobalIndex, num, integer);
                container.appendChild(svg);
            }
        }

        // --- رسم دایره ساده (تک رنگ برای تب ۲) ---
        function createSimplePieSVG(radius, partsToFill, totalSlices, color) {
             const size = 110;
            const center = size / 2;
            const svg = createSVGElement("svg", {width: size, height: size});
            
            // دایره محیط
            svg.appendChild(createSVGElement("circle", {
                cx: center, cy: center, r: radius, fill: "none", stroke: "#000", "stroke-width": 2.5
            }));

            // پر کردن
            if (partsToFill > 0) {
                const angleStep = (2 * Math.PI) / totalSlices;
                for(let i=0; i<partsToFill; i++) {
                     const startAngle = (i * angleStep) - (Math.PI / 2);
                     const endAngle = startAngle + angleStep;
                     const d = createSlicePath(center, center, radius, startAngle, endAngle);
                     svg.appendChild(createSVGElement("path", {
                        d: d, fill: color, stroke: "none", opacity: 0.8
                    }));
                }
            }
             // خطوط
            for (let k = 0; k < totalSlices; k++) {
                const angle = (k * 2 * Math.PI) / totalSlices - (Math.PI/2);
                const x2 = center + radius * Math.cos(angle);
                const y2 = center + radius * Math.sin(angle);
                svg.appendChild(createSVGElement("line", {
                    x1: center, y1: center, x2: x2, y2: y2, stroke: "#000", "stroke-width": 1.5
                }));
            }
            return svg;
        }

        function drawShapesDistributed(containerId, integer, num, den, color) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            for (let i = 0; i < integer; i++) {
                const svg = createSimplePieSVG(48, num, den, color);
                container.appendChild(svg);

                if (i < integer - 1) {
                    const plus = document.createElement("div");
                    plus.innerHTML = "+";
                    plus.style.fontSize = "30px";
                    plus.style.fontWeight = "bold";
                    plus.style.alignSelf = "center";
                    container.appendChild(plus);
                }
            }
        }

        // --- توابع محور ---
        
        function setupAxisBase(integer, num, den, mode) {
            const stepUnit = 100;
            const margin = 40;
            let maxVal;
            
            if (mode === 1) {
                const res = (integer * num) / den;
                maxVal = Math.ceil(res) + 1; 
            } else {
                maxVal = integer + 1; 
            }
            if(maxVal > 15) maxVal = 15; 

            const width = Math.max(600, (maxVal * stepUnit) + (2 * margin));
            const height = 180;
            const axisY = 120;

            const svg = createSVGElement("svg", {width: width, height: height, class: "axis-svg"});
            
            // تعریف مارکرها به صورت پویا
            const defs = createSVGElement("defs", {});
            let markersHTML = `
                <marker id="arrowBlack" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <path d="M0,0 L0,6 L9,3 z" fill="#000" />
                </marker>
                <marker id="arrowJumpBlue" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                    <path d="M0,0 L0,8 L12,4 z" fill="#3498db" />
                </marker>
            `;
            // ساخت مارکر رنگی برای هر رنگ موجود در پالت
            distinctColors.forEach((c, idx) => {
                 markersHTML += `
                    <marker id="arrowJump${idx}" markerWidth="12" markerHeight="12" refX="10" refY="4" orient="auto">
                        <path d="M0,0 L0,8 L12,4 z" fill="${c}" />
                    </marker>
                 `;
            });

            defs.innerHTML = markersHTML;
            svg.appendChild(defs);

            // خط محور
            svg.appendChild(createSVGElement("line", {
                x1: margin, y1: axisY, x2: width - margin, y2: axisY,
                stroke: "#000", "stroke-width": 3, "marker-end": "url(#arrowBlack)"
            }));

            // تیک‌ها
            for (let i = 0; i <= maxVal; i++) {
                const x = margin + i * stepUnit;
                svg.appendChild(createSVGElement("line", {
                    x1: x, y1: axisY - 12, x2: x, y2: axisY + 12, stroke: "#000", "stroke-width": 3
                }));
                const text = createSVGElement("text", {
                    x: x, y: axisY + 40, "text-anchor": "middle", 
                    "font-family": "Vazir", "font-weight": "bold", "font-size": "20px"
                });
                text.textContent = i;
                svg.appendChild(text);

                if (i < maxVal) {
                    for (let j = 1; j < den; j++) {
                        const subX = x + (j/den) * stepUnit;
                        svg.appendChild(createSVGElement("line", {
                            x1: subX, y1: axisY - 6, x2: subX, y2: axisY + 6, 
                            stroke: "#7f8c8d", "stroke-width": 1.5
                        }));
                    }
                }
            }

            return { svg, stepUnit, margin, axisY };
        }

        // محور نوع ۱: پرش متوالی رنگی
        function drawAxisSequential(containerId, integer, num, den) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const { svg, stepUnit, margin, axisY } = setupAxisBase(integer, num, den, 1);
            
            let currentPos = 0;
            const jumpVal = num/den; 
            const jumpPx = jumpVal * stepUnit;

            for (let k = 0; k < integer; k++) {
                const startX = margin + currentPos * stepUnit;
                const endX = margin + (currentPos + jumpVal) * stepUnit;
                
                const midX = (startX + endX) / 2;
                const arcHeight = 40;
                const controlY = axisY - arcHeight - (jumpPx / 5); 

                const colorIndex = k % distinctColors.length;
                const color = distinctColors[colorIndex];
                const markerId = `url(#arrowJump${colorIndex})`;

                const pathD = `M ${startX} ${axisY} Q ${midX} ${controlY} ${endX} ${axisY}`;
                
                svg.appendChild(createSVGElement("path", {
                    d: pathD, fill: "none", stroke: color, "stroke-width": 3, 
                    "marker-end": markerId
                }));
                
                // برچسب
                const label = createSVGElement("text", {
                        x: midX, y: controlY + 10, 
                        "text-anchor": "middle", fill: color, "font-size": "14px", "font-weight": "bold"
                });
                label.textContent = `${num}/${den}`;
                svg.appendChild(label);

                currentPos += jumpVal;
            }
            
            // نمایش نتیجه
            const finalX = margin + currentPos * stepUnit;
            svg.appendChild(createSVGElement("circle", {
                cx: finalX, cy: axisY, r: 6, fill: "#2c3e50"
            }));
            const resText = createSVGElement("text", {
                x: finalX, y: axisY + 65, 
                "text-anchor": "middle", fill: "#2c3e50", "font-weight": "bold", "font-size": "18px"
            });
            resText.textContent = `${integer * num}/${den}`;
            svg.appendChild(resText);

            container.appendChild(svg);
        }

        // محور نوع ۲ (همان قبلی تک رنگ آبی چون مفهوم توزیع است)
        function drawAxisPerUnit(containerId, integer, num, den) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            const { svg, stepUnit, margin, axisY } = setupAxisBase(integer, num, den, 2);

            for (let k = 0; k < integer; k++) {
                const startX = margin + (k * stepUnit);
                const endX = startX + (num/den) * stepUnit;
                const midX = (startX + endX) / 2;
                const arcHeight = 30;
                const controlY = axisY - arcHeight;

                const pathD = `M ${startX} ${axisY} Q ${midX} ${controlY} ${endX} ${axisY}`;

                svg.appendChild(createSVGElement("path", {
                    d: pathD, fill: "none", stroke: "#3498db", "stroke-width": 3, 
                    "marker-end": "url(#arrowJumpBlue)"
                }));
                
                 if (stepUnit * (num/den) > 25) {
                    const label = createSVGElement("text", {
                            x: midX, y: controlY + 5, 
                            "text-anchor": "middle", fill: "#2980b9", "font-size": "12px"
                    });
                    label.textContent = `${num}/${den}`;
                    svg.appendChild(label);
                }
            }
            
            container.appendChild(svg);
        }


        // --- UPDATE FUNCTIONS ---

        function updateTab1() {
            const intVal = parseInt(document.getElementById('t1-int').value);
            const numVal = parseInt(document.getElementById('t1-num').value);
            const denVal = parseInt(document.getElementById('t1-den').value);

            document.getElementById('t1-int-val').innerText = intVal;
            document.getElementById('t1-num-val').innerText = numVal;
            document.getElementById('t1-den-val').innerText = denVal;

            const resNum = intVal * numVal;
            const eqHTML = `${intVal} &times; ${makeFrac(numVal, denVal)} = ${makeFrac(resNum, denVal)}`;
            document.getElementById('t1-equation').innerHTML = eqHTML;

            // اینجا دیگر رنگ ثابت نمی‌فرستیم، خود تابع داخلی رنگ‌ها را مدیریت می‌کند
            drawShapesCumulative('t1-shapes', intVal, numVal, denVal);
            drawAxisSequential('t1-axis-container', intVal, numVal, denVal);
        }

        function updateTab2() {
            const intVal = parseInt(document.getElementById('t2-int').value);
            const numVal = parseInt(document.getElementById('t2-num').value);
            const denVal = parseInt(document.getElementById('t2-den').value);

            document.getElementById('t2-int-val').innerText = intVal;
            document.getElementById('t2-num-val').innerText = numVal;
            document.getElementById('t2-den-val').innerText = denVal;

            const eqHTML = `${makeFrac(numVal, denVal)} &times; ${intVal}`;
            document.getElementById('t2-equation').innerHTML = eqHTML;

            drawShapesDistributed('t2-shapes', intVal, numVal, denVal, "#3498db");
            drawAxisPerUnit('t2-axis-container', intVal, numVal, denVal);
        }

        function updateTab3() {
            const n1 = parseInt(document.getElementById('t3-n1').value);
            let d1 = parseInt(document.getElementById('t3-d1').value);
            const n2 = parseInt(document.getElementById('t3-n2').value);
            let d2 = parseInt(document.getElementById('t3-d2').value);

            if (n1 > d1) { d1 = n1; document.getElementById('t3-d1').value = n1; }
            if (n2 > d2) { d2 = n2; document.getElementById('t3-d2').value = n2; }

            document.getElementById('t3-n1-val').innerText = n1;
            document.getElementById('t3-d1-val').innerText = d1;
            document.getElementById('t3-n2-val').innerText = n2;
            document.getElementById('t3-d2-val').innerText = d2;

            const finalN = n1 * n2;
            const finalD = d1 * d2;
            const eqHTML = `${makeFrac(n1, d1)} &times; ${makeFrac(n2, d2)} = ${makeFrac(finalN, finalD)}`;
            document.getElementById('t3-equation').innerHTML = eqHTML;

            const gridWrapper = document.getElementById('t3-grid-wrapper');
            gridWrapper.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'grid-container';
            
            let cellSize = 50;
            if (d1 > 10 || d2 > 10) cellSize = 30;
            if (d1 > 15 || d2 > 15) cellSize = 24;

            grid.style.gridTemplateColumns = `repeat(${d1}, ${cellSize}px)`;
            grid.style.gridTemplateRows = `repeat(${d2}, ${cellSize}px)`;
            
            for (let r = 0; r < d2; r++) {
                for (let c = 0; c < d1; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    const inColSelection = c < n1;
                    const inRowSelection = r < n2; 
                    if (inColSelection && inRowSelection) {
                        cell.classList.add('fill-overlap');
                    } else if (inColSelection) {
                        cell.classList.add('fill-green');
                    } else if (inRowSelection) {
                        cell.classList.add('fill-yellow');
                    }
                    grid.appendChild(cell);
                }
            }
            gridWrapper.appendChild(grid);
        }

        switchTab('tab1');
    </script>
</body>
</html>
