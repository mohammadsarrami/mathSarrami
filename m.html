<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>آزمایشگاه کسر - ورودی دستی و شکل‌های چندگانه</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;900&display=swap');

        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #ffff99;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #333;
            min-height: 100vh;
        }

        /* کنترل‌ها */
        .controls-bar {
            background: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            border: 2px solid #fff;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        button {
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            font-family: inherit;
            transition: 0.2s;
        }
        .btn-add { background: #2ecc71; color: white; }
        .btn-rem { background: #e74c3c; color: white; }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; transform: none; }

        /* کانتینر کسرها */
        #fractions-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            width: 100%;
            margin-bottom: 20px;
        }

        .fraction-group {
            display: flex;
            flex-direction: column; /* تغییر به ستونی برای چیدمان بهتر */
            align-items: center;
            gap: 15px;
            background: rgba(255,255,255,0.6); 
            padding: 20px;
            border-radius: 25px;
            border: 2px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.08);
            width: 280px;
        }

        /* ناحیه ورودی دستی */
        .input-area {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fff;
            padding: 10px;
            border-radius: 15px;
            border: 1px solid #ddd;
        }

        /* استایل اینپوت‌ها */
        input[type="number"] {
            font-family: 'Vazirmatn', sans-serif;
            font-weight: 900;
            text-align: center;
            border: 2px solid #ccc;
            border-radius: 8px;
            transition: 0.3s;
            font-size: 1.2rem;
            color: #333;
            -moz-appearance: textfield; /* حذف دکمه‌های اسپینر فایرفاکس */
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"]:focus {
            border-color: #0099cc;
            outline: none;
            background: #f0f8ff;
        }

        .inp-whole {
            width: 50px;
            height: 50px;
            margin-left: 10px;
            font-size: 1.5rem !important;
        }

        .frac-inputs {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .inp-frac {
            width: 45px;
            height: 35px;
        }

        .frac-line {
            width: 100%;
            height: 3px;
            background: #333;
            border-radius: 2px;
        }

        /* ناحیه شکل‌ها */
        .pies-wrapper {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            min-height: 80px;
            align-items: center;
        }
        
        .pie-svg {
            width: 70px;
            height: 70px;
        }
        
        path, circle { transition: all 0.3s ease; }

        /* نمایش ریاضی */
        .math-display-area {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            direction: ltr;
        }

        /* استایل‌های ریاضی عمومی */
        .math-frac {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            vertical-align: middle;
            margin: 0 5px;
        }
        .math-frac .num, .math-frac .den {
            font-weight: 900; line-height: 1;
        }
        .math-frac .line {
            width: 100%; height: 2px; background-color: currentColor; margin: 2px 0;
        }
        .mixed-frac {
            display: inline-flex; align-items: center; margin: 0 5px;
        }
        .mixed-frac .whole {
            font-size: 1.2em; font-weight: 900; margin-right: 5px;
        }

        /* --- استایل محور --- */
        #axis-wrapper {
            width: 100%;
            background: rgba(255,255,255,0.2);
            margin-top: 20px;
            padding: 10px 0 30px 0;
            overflow-x: auto;
            border-top: 2px solid rgba(255,255,255,0.5);
            scrollbar-width: thin;
        }

        #axis-container {
            position: relative;
            height: 300px; 
            margin: 0 40px;
        }

        #main-axis-line {
            position: absolute;
            top: 150px;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: #333;
            z-index: 1;
            border-radius: 2px;
        }

        .axis-dot {
            position: absolute;
            top: 145px;
            width: 14px;
            height: 14px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 50%;
            z-index: 2;
            transform: translateX(-50%);
        }
        
        .axis-dot.integer-dot {
            width: 18px; height: 18px; top: 143px; border-width: 3px; background: #333;
        }

        .axis-number {
            position: absolute;
            top: 110px;
            transform: translateX(-50%);
            font-size: 1.4rem;
            font-weight: 900;
            color: #333;
        }

        .grid-dotted {
            position: absolute;
            top: 155px;
            width: 0;
            height: 140px;
            border-left: 2px dotted #0099cc;
            transform: translateX(-50%);
            z-index: 0;
            opacity: 0.4;
        }

        /* --- فلش‌ها --- */
        .arrow-pointer {
            position: absolute;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            transition: left 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
        }

        .arrow-pointer.pos-down { top: 165px; flex-direction: column; }
        .arrow-pointer.pos-up { top: 75px; flex-direction: column-reverse; }

        .arrow-shape {
            width: 0; height: 0; 
            border-left: 10px solid transparent; border-right: 10px solid transparent;
        }

        .pos-down .arrow-shape { border-bottom: 16px solid; margin-bottom: -2px; }
        .pos-up .arrow-shape { border-top: 16px solid; margin-top: -2px; }

        .arrow-label {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; padding: 5px 12px; border-radius: 12px;
            background: #fff; border: 2px solid;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            direction: ltr; font-size: 1rem; font-weight: bold;
        }

        /* تم‌ها */
        .theme-1 { color: #e74c3c; border-color: #e74c3c; } /* قرمز */
        .theme-1 .arrow-label { color: #e74c3c; border-color: #e74c3c; }
        .theme-1.pos-down .arrow-shape { border-bottom-color: #e74c3c; }
        .theme-1.pos-up .arrow-shape { border-top-color: #e74c3c; }
        
        .theme-2 { color: #3498db; border-color: #3498db; } /* آبی */
        .theme-2 .arrow-label { color: #3498db; border-color: #3498db; }
        .theme-2.pos-down .arrow-shape { border-bottom-color: #3498db; }
        .theme-2.pos-up .arrow-shape { border-top-color: #3498db; }

        .theme-3 { color: #27ae60; border-color: #27ae60; } /* سبز */
        .theme-3 .arrow-label { color: #27ae60; border-color: #27ae60; }
        .theme-3.pos-down .arrow-shape { border-bottom-color: #27ae60; }
        .theme-3.pos-up .arrow-shape { border-top-color: #27ae60; }

        .footer {
            margin-top: auto;
            width: 100%;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>
<body>

    <div class="controls-bar">
        <span style="font-weight:bold; color:#555; margin-left:10px;">مدیریت کسرها:</span>
        <button class="btn-add" onclick="addFraction()" id="addBtn">افزودن (+)</button>
        <button class="btn-rem" onclick="removeFraction()" id="removeBtn">حذف (-)</button>
        <div style="margin-right:30px; font-size:1rem; color:#444;">
            مخرج مشترک (LCM): <b id="lcm-val" style="font-size:1.6rem; color:#000; vertical-align:middle;">1</b>
        </div>
    </div>

    <div id="fractions-area"></div>

    <div style="width:95%; text-align:right; font-size:0.85rem; color:#666; margin-top:10px;">
        * اعداد را در کادرهای سفید تایپ کنید تا شکل‌ها و محور تغییر کنند.
    </div>

    <div id="axis-wrapper">
        <div id="axis-container">
            <div id="main-axis-line"></div>
        </div>
    </div>

    <div class="footer">
        طراح: آقای صرامی - مخصوص کلاس ششم دو
    </div>

<script>
    let fractionCount = 0;
    const maxFractions = 3;
    const maxAxisValue = 10; // طول محور
    const themes = ['theme-1', 'theme-2', 'theme-3'];
    // ساختار داده: هر آیتم شامل whole (صحیح)، num (صورت)، den (مخرج)
    let fractionsData = [];

    const container = document.getElementById('fractions-area');
    const axisContainer = document.getElementById('axis-container');

    const gcd = (a, b) => !b ? a : gcd(b, a % b);
    const lcm = (a, b) => (a * b) / gcd(a, b);

    function init() {
        addFraction(); // 1
        addFraction(); // 2
        // مقادیر اولیه: 1 واحد و 1/2 ، 0 واحد و 2/3
        updateInputValues(1, 1, 1, 2); 
        updateInputValues(2, 0, 2, 3);
        updateAllUI();
    }

    // تابع کمکی برای ساخت HTML کسر
    function createMathHTML(whole, num, den, showEqual = false, eqNum=0, eqDen=0) {
        let html = '';
        
        // بخش عدد اصلی
        if (whole > 0) {
            html += `<div class="mixed-frac"><span class="whole">${whole}</span>`;
        } else {
            html += `<div class="math-frac">`;
        }
        
        // بخش کسری
        if (num > 0 || (whole === 0 && num === 0)) { // اگر همه‌چیز صفر است باز هم صفر نشان بده
             html += `
                <div class="math-frac" style="${whole > 0 ? 'font-size:0.8em' : ''}">
                    <span class="num">${num}</span>
                    <div class="line"></div>
                    <span class="den">${den}</span>
                </div>`;
        }
        
        if (whole > 0) html += `</div>`; // بستن div mixed-frac

        // بخش مساوی (اگر خواسته شده باشد)
        if (showEqual) {
            // محاسبه کسر نامساوی کل برای نمایش
            const totalNum = (whole * den) + num;
            // اگر خود کسر با کسر معادل یکی بود نمایش نده
            if (eqDen !== den) {
                // محاسبه مقدار معادل برای whole و کسر
                 // اینجا برای سادگی فقط کسر معادل کل را نشان می‌دهیم یا کسر معادل جزء را؟
                 // بیایید کسر معادل را به صورت کسری (بدون عدد صحیح) نشان دهیم که فایده مخرج مشترک دیده شود
                 const totalEqNum = (whole * eqDen) + ((num * eqDen)/den);
                 
                 html += `<span style="margin:0 5px; font-size:1.2rem;">=</span>`;
                 html += `
                    <div class="math-frac">
                        <span class="num">${Math.round(totalEqNum)}</span>
                        <div class="line"></div>
                        <span class="den">${eqDen}</span>
                    </div>`;
            }
        }
        return html;
    }

    function addFraction() {
        if (fractionCount >= maxFractions) return;
        fractionCount++;
        const id = fractionCount;
        const theme = themes[id - 1];
        const positionClass = (id % 2 === 0) ? 'pos-up' : 'pos-down';

        // داده پیش‌فرض: 0 1/2
        fractionsData.push({ id: id, whole: 0, num: 1, den: 2 });

        const group = document.createElement('div');
        group.className = `fraction-group ${theme}`;
        group.id = `group-${id}`;
        
        group.innerHTML = `
            <!-- ناحیه شکل‌ها -->
            <div class="pies-wrapper" id="pies-${id}"></div>

            <!-- ناحیه ورودی دستی -->
            <div class="input-area">
                <div class="frac-inputs">
                    <input type="number" class="inp-frac" id="in-num-${id}" value="1" min="0" onchange="onInput(${id})" onkeyup="onInput(${id})">
                    <div class="frac-line"></div>
                    <input type="number" class="inp-frac" id="in-den-${id}" value="2" min="1" onchange="onInput(${id})" onkeyup="onInput(${id})">
                </div>
                <input type="number" class="inp-whole" id="in-whole-${id}" value="0" min="0" onchange="onInput(${id})" onkeyup="onInput(${id})" placeholder="0">
            </div>

            <!-- نمایش معادل -->
            <div class="math-display-area" id="display-area-${id}"></div>
        `;
        container.appendChild(group);

        // فلش محور
        const arrow = document.createElement('div');
        arrow.className = `arrow-pointer ${theme} ${positionClass}`;
        arrow.id = `arrow-${id}`;
        arrow.innerHTML = `
            <div class="arrow-shape"></div>
            <div class="arrow-label" id="arrow-txt-${id}"></div>
        `;
        axisContainer.appendChild(arrow);

        checkButtons();
        updateAllUI(); // رفرش اولیه
    }

    function removeFraction() {
        if (fractionCount <= 1) return;
        const lastId = fractionsData[fractionsData.length-1].id;
        document.getElementById(`group-${lastId}`).remove();
        document.getElementById(`arrow-${lastId}`).remove();
        fractionsData.pop();
        fractionCount--;
        updateAllUI();
        checkButtons();
    }

    function checkButtons() {
        document.getElementById('addBtn').disabled = fractionCount >= maxFractions;
        document.getElementById('removeBtn').disabled = fractionCount <= 1;
    }

    function onInput(id) {
        const wholeInp = document.getElementById(`in-whole-${id}`);
        const numInp = document.getElementById(`in-num-${id}`);
        const denInp = document.getElementById(`in-den-${id}`);

        let whole = parseInt(wholeInp.value) || 0;
        let num = parseInt(numInp.value) || 0;
        let den = parseInt(denInp.value) || 1;

        if (den < 1) { den = 1; denInp.value = 1; }
        if (num < 0) { num = 0; numInp.value = 0; }
        if (whole < 0) { whole = 0; wholeInp.value = 0; }
        
        // اگر صورت بیشتر از مخرج شد، اتوماتیک به عدد صحیح اضافه کن (اختیاری، فعلا غیرفعال برای آزادی عمل معلم)
        // اما برای دایره‌ها باید منطق درست باشد.
        
        updateFractionData(id, whole, num, den);
        updateAllUI();
    }

    function updateInputValues(id, w, n, d) {
        const idx = fractionsData.findIndex(f => f.id === id);
        if(idx !== -1) {
            fractionsData[idx].whole = w;
            fractionsData[idx].num = n;
            fractionsData[idx].den = d;
            document.getElementById(`in-whole-${id}`).value = w;
            document.getElementById(`in-num-${id}`).value = n;
            document.getElementById(`in-den-${id}`).value = d;
        }
    }

    function updateFractionData(id, w, n, d) {
        const idx = fractionsData.findIndex(f => f.id === id);
        if(idx !== -1) {
            fractionsData[idx].whole = w;
            fractionsData[idx].num = n;
            fractionsData[idx].den = d;
        }
    }

    function getCommonDenominator() {
        if (fractionsData.length === 0) return 1;
        let res = fractionsData[0].den;
        for (let i = 1; i < fractionsData.length; i++) {
            res = lcm(res, fractionsData[i].den);
        }
        return res;
    }

    function updateAllUI() {
        // 1. رسم محور
        const commonDenom = getCommonDenominator();
        document.getElementById('lcm-val').innerText = commonDenom;
        
        const minPixelsPerDot = 30;
        const pixelsPerInteger = Math.max(120, commonDenom * minPixelsPerDot);
        
        drawAxis(commonDenom, pixelsPerInteger);

        // 2. بروزرسانی هر کسر
        fractionsData.forEach(d => {
            const {id, whole, num, den} = d;
            
            // رسم دایره‌ها
            drawPies(id, whole, num, den);

            // محاسبه موقعیت روی محور
            // مقدار واقعی = عدد صحیح + (صورت/مخرج)
            const totalVal = whole + (num / den);
            
            const leftPx = totalVal * pixelsPerInteger;
            const arrow = document.getElementById(`arrow-${id}`);
            arrow.style.left = leftPx + 'px';

            // متن داخل فلش
            const arrowTxt = document.getElementById(`arrow-txt-${id}`);
            // نمایش: عدد مخلوط = کسر بزرگ معادل
            // کسر بزرگ معادل: (whole * commonDenom) + (num * (commonDenom/den)) / commonDenom
            
            arrowTxt.innerHTML = createMathHTML(whole, num, den, true, 0, commonDenom);
            
            // متن زیر کارت (برای نمایش کسر معادل)
            const disp = document.getElementById(`display-area-${id}`);
            disp.innerHTML = `<span style="color:#777; font-size:0.9rem;">معادل با مخرج ${commonDenom}: </span>` + 
                             createMathHTML(0, Math.round(totalVal * commonDenom), commonDenom); 
        });
    }

    function drawAxis(commonDenom, pixelsPerInteger) {
        // پاک کردن محور قبلی
        const dots = axisContainer.querySelectorAll('.axis-dot, .grid-dotted, .axis-number');
        dots.forEach(e => e.remove());

        const totalWidth = pixelsPerInteger * maxAxisValue;
        axisContainer.style.width = (totalWidth + 100) + 'px';

        const totalSteps = maxAxisValue * commonDenom;

        for (let i = 0; i <= totalSteps; i++) {
            const value = i / commonDenom;
            const leftPos = (value * pixelsPerInteger); 
            const isInteger = Math.abs(value - Math.round(value)) < 0.001; // بررسی صحیح بودن

            // نقطه
            const dot = document.createElement('div');
            dot.className = isInteger ? 'axis-dot integer-dot' : 'axis-dot';
            dot.style.left = leftPos + 'px';
            
            // خط عمودی رنگی
            const grid = document.createElement('div');
            grid.className = 'grid-dotted';
            grid.style.left = leftPos + 'px';
            
            axisContainer.appendChild(dot);
            axisContainer.appendChild(grid);

            // عدد
            if (isInteger) {
                const numLabel = document.createElement('div');
                numLabel.className = 'axis-number';
                numLabel.innerText = Math.round(value);
                numLabel.style.left = leftPos + 'px';
                axisContainer.appendChild(numLabel);
            }
        }
    }

    function drawPies(id, whole, num, den) {
        const wrapper = document.getElementById(`pies-${id}`);
        wrapper.innerHTML = ''; // پاک کردن قبلی‌ها

        // تعیین رنگ بر اساس تم
        const themeColor = id === 1 ? '#e74c3c' : (id === 2 ? '#3498db' : '#27ae60');

        // 1. رسم دایره‌های کامل (به تعداد عدد صحیح)
        // اگر صورت از مخرج بزرگتر است (مثلا کسر 5/4 و عدد صحیح 0)، باید دایره اضافه تولید کنیم
        let extraWhole = Math.floor(num / den);
        let remainingNum = num % den;
        
        let totalFullCircles = whole + extraWhole;
        
        // اگر کلا صفر است، حداقل یک دایره خالی بکش
        if (totalFullCircles === 0 && remainingNum === 0) {
            wrapper.appendChild(createSinglePieSVG(0, 1, themeColor));
            return;
        }

        // دایره‌های پر
        for(let i=0; i<totalFullCircles; i++) {
            wrapper.appendChild(createSinglePieSVG(1, 1, themeColor, true)); // 1/1 یعنی پر
        }

        // دایره کسری (باقیمانده)
        if (remainingNum > 0) {
            wrapper.appendChild(createSinglePieSVG(remainingNum, den, themeColor));
        }
    }

    function createSinglePieSVG(num, den, color, isFull = false) {
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("class", "pie-svg");
        svg.setAttribute("viewBox", "0 0 100 100");

        const cx = 50, cy = 50, r = 48;

        // دایره پایه (خالی)
        const baseCircle = document.createElementNS(svgNS, "circle");
        baseCircle.setAttribute("cx", cx); baseCircle.setAttribute("cy", cy); baseCircle.setAttribute("r", r);
        baseCircle.setAttribute("fill", "#fff"); baseCircle.setAttribute("stroke", "#333"); baseCircle.setAttribute("stroke-width", "2");
        svg.appendChild(baseCircle);

        if (isFull) {
            const fullCircle = document.createElementNS(svgNS, "circle");
            fullCircle.setAttribute("cx", cx); fullCircle.setAttribute("cy", cy); fullCircle.setAttribute("r", r);
            fullCircle.setAttribute("fill", color); fullCircle.setAttribute("stroke", "#333"); fullCircle.setAttribute("stroke-width", "2");
            svg.appendChild(fullCircle);
        } 
        else if (num > 0) {
            // رسم قطاع‌ها
            // اگر دنومیناتور 1 باشد که عملا پر است، اما اینجا هندل می‌کنیم
            const step = 360 / den;
            
            // رسم قطاع پر شده
            // ساخت path برای قسمت پر شده
            // ما فرض می‌کنیم تکه‌ها کنار هم هستند، پس یک آرک بزرگ می‌کشیم
            const endAngle = (num * step) - 90;
            const startAngle = -90; // از ساعت 12 شروع
            
            const x1 = cx + r * Math.cos(startAngle * Math.PI/180);
            const y1 = cy + r * Math.sin(startAngle * Math.PI/180);
            const x2 = cx + r * Math.cos(endAngle * Math.PI/180);
            const y2 = cy + r * Math.sin(endAngle * Math.PI/180);
            
            // فلگ بزرگ بودن کمان (اگر بیشتر از 180 درجه است)
            const largeArcFlag = (num * step) > 180 ? 1 : 0;

            const d = `M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
            
            const path = document.createElementNS(svgNS, "path");
            path.setAttribute("d", d);
            path.setAttribute("fill", color);
            path.setAttribute("stroke", "#333");
            path.setAttribute("stroke-width", "2");
            svg.appendChild(path);

            // خطوط تقسیم‌بندی کل دایره
            for(let i=0; i<den; i++) {
                const angle = (i * step) - 90;
                const lx = cx + r * Math.cos(angle * Math.PI/180);
                const ly = cy + r * Math.sin(angle * Math.PI/180);
                
                const line = document.createElementNS(svgNS, "line");
                line.setAttribute("x1", cx); line.setAttribute("y1", cy);
                line.setAttribute("x2", lx); line.setAttribute("y2", ly);
                line.setAttribute("stroke", "#333");
                line.setAttribute("stroke-width", "1");
                line.setAttribute("opacity", "0.5");
                svg.appendChild(line);
            }
        }

        return svg;
    }

    init();
</script>
</body>
</html>
